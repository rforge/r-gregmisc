#!/bin/sh

# Configuration Variables
NWS_SERVER_DIR=${NWS_SERVER_DIR:=/grid/gro/vol/minigrid/rstatserver/devel/nws/}
TWISTD=${TWISTD:=/grid/gro/vol/minigrid/python-2.4.1/bin/twistd}

NWS_PID=${NWS_SERVER_DIR}/nws.pid
NWS_LOG=${NWS_SERVER_DIR}/nws.log

RBABEL_PID=${NWS_SERVER_DIR}/RBabel.pid
RBABEL_LOG=${NWS_SERVER_DIR}/RBabel.log

#D=`dirname $0`
#echo "Using NWS_SERVER_DIR: ${NWS_SERVER_DIR:=$D}"
#echo "Using NWS_TWISTD:     ${TWISTD:=$NWS_TWISTD}"

if [ ! -d ${NWS_SERVER_DIR} ]
then
    echo "Directory doesn't exist: ${NWS_SERVER_DIR}" 1>&2
    exit 2
fi

if [ ! -w ${NWS_SERVER_DIR} ]
then
    echo "Directory isn't writable: ${NWS_SERVER_DIR}" 1>&2
    exit 2
fi

case $# in
0)
    echo "usage: $0 [start|stop]" 1>&2
    exit 1
    ;;
esac

case "$1" in
start)
    ## start NWS Server
    if [ -f ${NWS_PID} ]
    then
        echo "${NWS_PID} file exists: is the nws server already running?" 1>&2
        echo "(remove ${NWS_PID} to force execution)" 1>&2
	exit 3
    fi
    /bin/rm -f ${NWS_LOG} _tmp*
    echo "Starting the NWS server..."
    ( 
      cd ${NWS_SERVER_DIR} ; 
      ${TWISTD} -oy ${NWS_SERVER_DIR}/nwsServer.py --pidfile=${NWS_PID}
    )
    echo "Done."

    ## start R Babelfish
    if [ -f ${RBABEL_PID} ]
    then
        echo "${RBABEL_PID} file exists: is the R Bablefish already running?" 1>&2
        echo "(remove ${RBABELS_PID} to force execution)" 1>&2
	exit 3
    fi
    /bin/rm -f ${NWS_LOG} _tmp*
    echo "Starting the R Babelfish..."
    ( 
      cd ${NWS_SERVER_DIR} ; 
      R CMD BATCH --pidfile=${RBABEL_PID} ${NWS_SERVER_DIR}/babelfish.R &
    )
    echo "Done."    
    ;;
stop)
    ## stop NWS server
    if [ ! -f ${NWS_PID} ]
    then
        echo "${NWS_PID} file doesn't exist: is the server really running?" 1>&2
	exit 4
    fi
    echo "Stopping the NWS server..."
    kill `cat ${NWS_PID}`
    echo "Done."

    ## stop R Babelfish 
    if [ ! -f ${RBABEL_PID} ]
    then
        echo "${RBABEL_PID} file doesn't exist: is the server really running?" 1>&2
	exit 4
    fi
    echo "Stopping the R Babelfish server..."
    kill `cat ${RBABEL_PID}`
    echo "Done."


    ;;
*)
    echo "usage: $0 [start|stop]" 1>&2
    exit 1
    ;;
esac

exit 0
